# 要件定義書：AI Orchestration Dashboard

**文書番号**: REQ-2026-002
**作成日**: 2026年1月18日
**作成者**: Cosara + Claude Code
**ステータス**: Draft
**関連文書**: PRJ-2026-002

---

## 1. 概要

### 1.1 目的

本文書は、AI Orchestration Dashboard (AOD) の機能要件および非機能要件を定義する。

### 1.2 スコープ

- Dashboard Frontend (Web UI)
- Unified API Gateway (バックエンド)
- Event Collector (Hooks統合)
- Redis Adapter (MCP状態連携)
- 既存MCP Orchestration Serverとの統合

### 1.3 用語定義

| 用語 | 定義 |
|------|------|
| Agent | Claude Codeインスタンス（Orchestrator, Planning, Implementation, Testing） |
| Task | エージェントに割り当てられる作業単位 |
| Event | Hooksから送信されるエージェント活動のログ |
| Session | エージェントの実行単位（起動から終了まで） |
| HITL | Human-In-The-Loop（人間介入） |

---

## 2. 機能要件

### 2.1 ダッシュボード表示機能

#### FR-001: エージェント状態表示

| ID | 要件 | 優先度 |
|----|------|--------|
| FR-001-01 | 登録済みエージェントの一覧を表示する | P0 |
| FR-001-02 | 各エージェントの状態（idle/busy/offline）を表示する | P0 |
| FR-001-03 | エージェントの役割（Orchestrator/Planning/Implementation/Testing）を色分け表示する | P0 |
| FR-001-04 | エージェントの最終活動時刻を表示する | P1 |
| FR-001-05 | エージェントの接続プロジェクトを表示する | P1 |

**受入基準:**
- [ ] 4種類のエージェントが色分けで識別可能
- [ ] 状態変更が5秒以内にUIに反映される
- [ ] オフラインエージェントがグレーアウト表示される

#### FR-002: タスク状態表示

| ID | 要件 | 優先度 |
|----|------|--------|
| FR-002-01 | タスク一覧を状態別（pending/in_progress/completed/failed）に表示する | P0 |
| FR-002-02 | 各タスクの詳細（ID, 担当エージェント, 作成時刻, 更新時刻）を表示する | P0 |
| FR-002-03 | タスクのフィルタリング（状態、エージェント、期間）ができる | P1 |
| FR-002-04 | 失敗タスクのエラーメッセージを表示する | P0 |
| FR-002-05 | デッドレターキューのタスクを別セクションで表示する | P1 |

**受入基準:**
- [ ] タスク状態が色分けで識別可能（pending:黄, in_progress:青, completed:緑, failed:赤）
- [ ] フィルタ適用後1秒以内に結果表示
- [ ] タスク詳細がモーダルで確認可能

#### FR-003: リアルタイムイベント表示

| ID | 要件 | 優先度 |
|----|------|--------|
| FR-003-01 | Hooksから受信したイベントをリアルタイムで表示する | P0 |
| FR-003-02 | イベントタイプ別（PreToolUse/PostToolUse/Notification等）にフィルタできる | P1 |
| FR-003-03 | セッションIDでグループ化表示できる | P1 |
| FR-003-04 | イベントのタイムライン表示ができる | P2 |
| FR-003-05 | 過去イベントの検索ができる | P2 |

**受入基準:**
- [ ] イベント受信から表示まで100ms以内
- [ ] 直近300件のイベントが初期ロードで表示
- [ ] イベントタイプ別にアイコン表示

#### FR-004: プロジェクト管理

| ID | 要件 | 優先度 |
|----|------|--------|
| FR-004-01 | 複数プロジェクトを切り替えて表示できる | P1 |
| FR-004-02 | プロジェクト別の統計サマリーを表示する | P2 |
| FR-004-03 | プロジェクトの追加・削除ができる | P2 |

**受入基準:**
- [ ] プロジェクト切替が1秒以内に完了
- [ ] 各プロジェクトのエージェント数、タスク数が表示される

---

### 2.2 制御機能

#### FR-005: タスク作成

| ID | 要件 | 優先度 |
|----|------|--------|
| FR-005-01 | ダッシュボードからタスクを作成できる | P1 |
| FR-005-02 | タスクの担当エージェントタイプを指定できる | P1 |
| FR-005-03 | タスクの優先度を設定できる | P2 |
| FR-005-04 | タスクの依存関係を設定できる | P3 |

**受入基準:**
- [ ] フォーム入力でタスク作成が完了
- [ ] 作成後、タスク一覧に即時反映

#### FR-006: HITL介入

| ID | 要件 | 優先度 |
|----|------|--------|
| FR-006-01 | 特定エージェントにメッセージを送信できる | P1 |
| FR-006-02 | 実行中タスクをキャンセルできる | P1 |
| FR-006-03 | 失敗タスクをリトライできる | P1 |
| FR-006-04 | 共有状態(shared_state)を確認・編集できる | P2 |

**受入基準:**
- [ ] メッセージ送信後、エージェントが次のポーリングで受信
- [ ] キャンセル操作後、タスク状態が即時更新

---

### 2.3 分析機能

#### FR-007: メトリクス表示

| ID | 要件 | 優先度 |
|----|------|--------|
| FR-007-01 | タスク完了率を表示する | P2 |
| FR-007-02 | 平均タスク実行時間を表示する | P2 |
| FR-007-03 | エージェント別の稼働率を表示する | P2 |
| FR-007-04 | 時間帯別のアクティビティグラフを表示する | P3 |

**受入基準:**
- [ ] 直近24時間/7日間/30日間の切替が可能
- [ ] グラフがChart.jsで描画される

#### FR-008: アラート・通知

| ID | 要件 | 優先度 |
|----|------|--------|
| FR-008-01 | タスク失敗時にブラウザ通知を表示する | P2 |
| FR-008-02 | エージェントがオフラインになった時に警告を表示する | P2 |
| FR-008-03 | タイムアウト検出時にアラートを表示する | P2 |

**受入基準:**
- [ ] 通知権限の許可フロー実装
- [ ] 通知のON/OFF設定が可能

---

## 3. 非機能要件

### 3.1 性能要件

| ID | 要件 | 目標値 |
|----|------|--------|
| NFR-001 | WebSocket遅延 | 100ms以内 |
| NFR-002 | API応答時間 | 200ms以内（P95） |
| NFR-003 | ダッシュボード初期ロード | 2秒以内 |
| NFR-004 | 同時接続クライアント数 | 10以上 |
| NFR-005 | イベント保存件数 | 100,000件以上 |

### 3.2 可用性要件

| ID | 要件 | 目標値 |
|----|------|--------|
| NFR-006 | システム稼働率 | 99%（開発環境） |
| NFR-007 | 自動再接続 | WebSocket切断後5秒以内 |
| NFR-008 | データ永続性 | SQLite WALモードで保証 |

### 3.3 セキュリティ要件

| ID | 要件 | 説明 |
|----|------|------|
| NFR-009 | ローカルアクセス限定 | 初期版はlocalhostのみ |
| NFR-010 | 認証なし | ローカル開発環境のため |
| NFR-011 | 入力バリデーション | XSS/インジェクション対策 |

### 3.4 拡張性要件

| ID | 要件 | 説明 |
|----|------|------|
| NFR-012 | モジュラー設計 | コンポーネント単位で追加・置換可能 |
| NFR-013 | プラグイン対応 | 将来的な外部統合のための拡張ポイント |

### 3.5 運用性要件

| ID | 要件 | 説明 |
|----|------|------|
| NFR-014 | ワンコマンド起動 | docker compose up で全サービス起動 |
| NFR-015 | ログ出力 | 構造化ログ（JSON）で出力 |
| NFR-016 | ヘルスチェック | /health エンドポイント提供 |

---

## 4. インターフェース要件

### 4.1 外部インターフェース

#### IF-001: Claude Code Hooks

| 項目 | 仕様 |
|------|------|
| プロトコル | HTTP POST |
| エンドポイント | POST /api/events |
| Content-Type | application/json |
| 必須フィールド | source_app, session_id, hook_event_type, payload |

```json
{
  "source_app": "project-name",
  "session_id": "uuid-session-id",
  "hook_event_type": "PostToolUse",
  "payload": {
    "tool_name": "Edit",
    "result": "success"
  },
  "timestamp": "2026-01-18T12:00:00Z"
}
```

#### IF-002: Redis (MCP Server)

| 項目 | 仕様 |
|------|------|
| プロトコル | Redis Protocol |
| 接続先 | localhost:6379 |
| キー構造 | agent:{id}, task:{id}, queue:{type} |

#### IF-003: WebSocket (クライアント)

| 項目 | 仕様 |
|------|------|
| プロトコル | WebSocket |
| エンドポイント | ws://localhost:4000/ws |
| メッセージ形式 | JSON |

```json
{
  "type": "event",
  "data": { ... }
}
```

### 4.2 内部インターフェース

#### REST API

| メソッド | パス | 説明 |
|----------|------|------|
| GET | /api/agents | エージェント一覧取得 |
| GET | /api/agents/:id | エージェント詳細取得 |
| GET | /api/tasks | タスク一覧取得 |
| GET | /api/tasks/:id | タスク詳細取得 |
| POST | /api/tasks | タスク作成 |
| DELETE | /api/tasks/:id | タスクキャンセル |
| GET | /api/events | イベント一覧取得 |
| GET | /api/projects | プロジェクト一覧取得 |
| GET | /api/metrics | メトリクス取得 |
| GET | /health | ヘルスチェック |

---

## 5. データ要件

### 5.1 データモデル

#### Event（イベント）

| フィールド | 型 | 説明 |
|------------|-----|------|
| id | INTEGER | 主キー（自動採番） |
| source_app | TEXT | プロジェクト名 |
| session_id | TEXT | セッションID |
| hook_event_type | TEXT | イベントタイプ |
| payload | JSON | イベントデータ |
| timestamp | DATETIME | 受信時刻 |
| created_at | DATETIME | 作成時刻 |

#### Agent（エージェント）- Redis

| キー | 型 | 説明 |
|------|-----|------|
| agent:{id} | HASH | エージェント情報 |
| - id | STRING | エージェントID |
| - type | STRING | planning/implementation/testing |
| - status | STRING | idle/busy/offline |
| - capabilities | JSON | 能力情報 |
| - last_heartbeat | STRING | 最終活動時刻 |

#### Task（タスク）- Redis

| キー | 型 | 説明 |
|------|-----|------|
| task:{id} | HASH | タスク情報 |
| - id | STRING | タスクID |
| - agent_type | STRING | 担当エージェントタイプ |
| - status | STRING | pending/in_progress/completed/failed |
| - description | STRING | タスク説明 |
| - created_at | STRING | 作成時刻 |
| - started_at | STRING | 開始時刻 |
| - completed_at | STRING | 完了時刻 |
| - error_message | STRING | エラーメッセージ |

### 5.2 データ保持ポリシー

| データ種別 | 保持期間 | 保存先 |
|------------|----------|--------|
| Event | 30日間 | SQLite |
| Agent | 永続 | Redis |
| Task | 7日間 | Redis |
| Metrics | 90日間 | SQLite |

---

## 6. 制約事項

### 6.1 技術的制約

| 制約 | 説明 |
|------|------|
| ローカル環境限定 | 本番デプロイは対象外 |
| 既存MCP Server依存 | mcp-orchestration-serverの構造に依存 |
| Redis必須 | MCPサーバーのバックエンドとして必要 |

### 6.2 運用制約

| 制約 | 説明 |
|------|------|
| 単一ユーザー想定 | マルチユーザー対応は対象外 |
| 認証なし | ローカル開発環境のため |

---

## 7. 依存関係

### 7.1 外部依存

| 依存先 | バージョン | 用途 |
|--------|-----------|------|
| mcp-orchestration-server | 最新 | 制御プレーン |
| Redis | 7.x | データストア |
| Docker | 最新 | コンテナ実行 |
| Claude Code | 最新 | Hooks送信元 |

### 7.2 内部依存

| コンポーネント | 依存先 |
|----------------|--------|
| Dashboard | API Gateway |
| API Gateway | Event Collector, Redis Adapter |
| Event Collector | SQLite |
| Redis Adapter | Redis |

---

## 8. 受入テスト項目

### 8.1 機能テスト

| ID | テスト項目 | 期待結果 |
|----|------------|----------|
| AT-001 | エージェント状態表示 | 4エージェントが色分けで表示される |
| AT-002 | タスク一覧表示 | 状態別にタスクが分類表示される |
| AT-003 | リアルタイムイベント | Hooks送信後100ms以内に表示 |
| AT-004 | タスク作成 | フォームからタスクが作成できる |
| AT-005 | WebSocket再接続 | 切断後5秒以内に再接続 |

### 8.2 性能テスト

| ID | テスト項目 | 期待結果 |
|----|------------|----------|
| PT-001 | 初期ロード時間 | 2秒以内 |
| PT-002 | API応答時間 | 200ms以内（P95） |
| PT-003 | 同時接続 | 10クライアント同時接続で動作 |

---

## 変更履歴

| バージョン | 日付 | 変更者 | 変更内容 |
|-----------|------|--------|----------|
| 1.0 | 2026/01/18 | Cosara + Claude | 初版作成 |
