# 設計書：AI Orchestration Dashboard

**文書番号**: DES-2026-002
**作成日**: 2026年1月18日
**作成者**: Cosara + Claude Code
**ステータス**: Draft
**関連文書**: PRJ-2026-002, REQ-2026-002

---

## 1. システムアーキテクチャ

### 1.1 全体構成図

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              Client Layer                                    │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │                    Dashboard Frontend (Next.js)                        │  │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐     │  │
│  │  │ AgentPanel  │ │ TaskPanel   │ │ EventPanel  │ │ MetricsPanel│     │  │
│  │  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘     │  │
│  │                              ↓                                         │  │
│  │  ┌─────────────────────────────────────────────────────────────────┐  │  │
│  │  │              State Management (Zustand / React Query)            │  │  │
│  │  └─────────────────────────────────────────────────────────────────┘  │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────────┘
                    ↓ REST API                    ↓ WebSocket
┌─────────────────────────────────────────────────────────────────────────────┐
│                              API Layer                                       │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │                 Unified API Gateway (Bun + Hono)                       │  │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐     │  │
│  │  │ /api/agents │ │ /api/tasks  │ │ /api/events │ │ /ws         │     │  │
│  │  └──────┬──────┘ └──────┬──────┘ └──────┬──────┘ └──────┬──────┘     │  │
│  │         │               │               │               │             │  │
│  │  ┌──────┴───────────────┴───────────────┴───────────────┴──────┐     │  │
│  │  │                    Service Layer                             │     │  │
│  │  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐       │     │  │
│  │  │  │ AgentService │  │ TaskService  │  │ EventService │       │     │  │
│  │  │  └──────────────┘  └──────────────┘  └──────────────┘       │     │  │
│  │  └─────────────────────────────────────────────────────────────┘     │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────────┘
                    ↓                                     ↓
┌───────────────────────────────┐     ┌───────────────────────────────────────┐
│        Data Layer             │     │           Integration Layer            │
│  ┌─────────────────────────┐  │     │  ┌─────────────────────────────────┐  │
│  │   SQLite (WAL mode)     │  │     │  │         Redis Adapter           │  │
│  │  ┌─────────┐            │  │     │  │  ┌─────────────────────────┐    │  │
│  │  │ events  │            │  │     │  │  │ MCP Orchestration Server│    │  │
│  │  │ metrics │            │  │     │  │  │ (既存: Redis Backend)   │    │  │
│  │  └─────────┘            │  │     │  │  └─────────────────────────┘    │  │
│  └─────────────────────────┘  │     │  └─────────────────────────────────┘  │
└───────────────────────────────┘     └───────────────────────────────────────┘
                                                          ↓ MCP Protocol
┌─────────────────────────────────────────────────────────────────────────────┐
│                           Agent Layer                                        │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐           │
│  │ Orchestrator│ │  Planning   │ │Implementation│ │  Testing   │           │
│  │   (紫)      │ │   (青)      │ │    (緑)      │ │   (橙)     │           │
│  │   Cursor    │ │   Cursor    │ │   Cursor     │ │   Cursor   │           │
│  └──────┬──────┘ └──────┬──────┘ └──────┬───────┘ └──────┬─────┘           │
│         └────────────────┴───────────────┴───────────────┘                  │
│                                  ↓ Hooks (HTTP POST)                         │
│                          API Gateway /api/events                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 1.2 技術スタック

| レイヤー | 技術 | 選定理由 |
|----------|------|----------|
| Frontend | Next.js 14 (App Router) | 既存テンプレート活用、RSC対応 |
| State Management | Zustand + React Query | 軽量、WebSocket統合が容易 |
| Styling | Tailwind CSS + shadcn/ui | 高速開発、一貫性 |
| Charts | Chart.js / Recharts | 軽量、カスタマイズ性 |
| API Gateway | Bun + Hono | 高速、TypeScript native |
| Database | SQLite (better-sqlite3) | WALモード、ゼロ設定 |
| Redis Client | ioredis | 高機能、TypeScript対応 |
| WebSocket | Bun WebSocket | 組み込み、高性能 |

---

## 2. コンポーネント設計

### 2.1 Frontend コンポーネント構成

```
src/
├── app/
│   ├── layout.tsx              # ルートレイアウト
│   ├── page.tsx                # ダッシュボードメイン
│   ├── agents/
│   │   └── page.tsx            # エージェント詳細
│   ├── tasks/
│   │   └── page.tsx            # タスク管理
│   ├── events/
│   │   └── page.tsx            # イベントログ
│   └── metrics/
│       └── page.tsx            # メトリクス
├── components/
│   ├── layout/
│   │   ├── Header.tsx          # ヘッダー
│   │   ├── Sidebar.tsx         # サイドバー
│   │   └── ProjectSelector.tsx # プロジェクト切替
│   ├── agents/
│   │   ├── AgentCard.tsx       # エージェントカード
│   │   ├── AgentList.tsx       # エージェント一覧
│   │   └── AgentStatus.tsx     # ステータスバッジ
│   ├── tasks/
│   │   ├── TaskCard.tsx        # タスクカード
│   │   ├── TaskList.tsx        # タスク一覧
│   │   ├── TaskFilter.tsx      # フィルター
│   │   └── TaskCreateModal.tsx # タスク作成モーダル
│   ├── events/
│   │   ├── EventItem.tsx       # イベント項目
│   │   ├── EventTimeline.tsx   # タイムライン表示
│   │   └── EventFilter.tsx     # フィルター
│   └── metrics/
│       ├── MetricCard.tsx      # メトリクスカード
│       └── ActivityChart.tsx   # アクティビティグラフ
├── hooks/
│   ├── useWebSocket.ts         # WebSocket接続管理
│   ├── useAgents.ts            # エージェントデータ
│   ├── useTasks.ts             # タスクデータ
│   └── useEvents.ts            # イベントデータ
├── stores/
│   ├── agentStore.ts           # エージェント状態
│   ├── taskStore.ts            # タスク状態
│   └── eventStore.ts           # イベント状態
├── lib/
│   ├── api.ts                  # APIクライアント
│   ├── websocket.ts            # WebSocketクライアント
│   └── utils.ts                # ユーティリティ
└── types/
    └── index.ts                # 型定義
```

### 2.2 Backend コンポーネント構成

```
server/
├── src/
│   ├── index.ts                # エントリーポイント
│   ├── routes/
│   │   ├── agents.ts           # /api/agents
│   │   ├── tasks.ts            # /api/tasks
│   │   ├── events.ts           # /api/events
│   │   ├── metrics.ts          # /api/metrics
│   │   └── health.ts           # /health
│   ├── services/
│   │   ├── agentService.ts     # エージェント操作
│   │   ├── taskService.ts      # タスク操作
│   │   ├── eventService.ts     # イベント操作
│   │   └── metricsService.ts   # メトリクス集計
│   ├── adapters/
│   │   ├── redis.ts            # Redis接続
│   │   └── sqlite.ts           # SQLite接続
│   ├── websocket/
│   │   ├── handler.ts          # WebSocketハンドラ
│   │   └── broadcaster.ts      # ブロードキャスト
│   ├── middleware/
│   │   ├── cors.ts             # CORS
│   │   ├── logger.ts           # ロギング
│   │   └── validation.ts       # バリデーション
│   └── types/
│       └── index.ts            # 型定義
├── db/
│   ├── schema.sql              # スキーマ定義
│   └── migrations/             # マイグレーション
└── package.json
```

---

## 3. データベース設計

### 3.1 SQLite スキーマ

```sql
-- イベントテーブル
CREATE TABLE events (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    source_app TEXT NOT NULL,
    session_id TEXT NOT NULL,
    hook_event_type TEXT NOT NULL,
    payload JSON NOT NULL,
    timestamp DATETIME NOT NULL,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,

    -- インデックス
    INDEX idx_events_session (session_id),
    INDEX idx_events_type (hook_event_type),
    INDEX idx_events_timestamp (timestamp)
);

-- メトリクステーブル
CREATE TABLE metrics (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    metric_name TEXT NOT NULL,
    metric_value REAL NOT NULL,
    dimensions JSON,
    timestamp DATETIME DEFAULT CURRENT_TIMESTAMP,

    INDEX idx_metrics_name (metric_name),
    INDEX idx_metrics_timestamp (timestamp)
);

-- プロジェクトテーブル
CREATE TABLE projects (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name TEXT UNIQUE NOT NULL,
    description TEXT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

### 3.2 Redis キー設計（既存MCPサーバー）

```
# エージェント
agent:{agent_id}                    # HASH: エージェント情報
  - id: string
  - type: "planning" | "implementation" | "testing"
  - status: "idle" | "busy" | "offline"
  - capabilities: JSON
  - last_heartbeat: ISO8601

# タスク
task:{task_id}                      # HASH: タスク情報
  - id: string
  - trace_id: string
  - agent_type: string
  - status: "pending" | "in_progress" | "completed" | "failed"
  - description: string
  - created_at: ISO8601
  - started_at: ISO8601
  - completed_at: ISO8601
  - error_message: string
  - retry_count: number

# キュー
queue:{agent_type}                  # LIST: タスクキュー
dead_letter_queue                   # LIST: 失敗タスク

# 共有状態
shared_state:{key}                  # STRING: 共有データ

# メトリクス
metrics:taskCreatedTotal            # STRING: カウンター
metrics:taskDurationSeconds         # STRING: ヒストグラム
```

---

## 4. API設計

### 4.1 REST API

#### エージェント API

```typescript
// GET /api/agents
// エージェント一覧取得
interface GetAgentsResponse {
  agents: Agent[];
  total: number;
}

interface Agent {
  id: string;
  type: "orchestrator" | "planning" | "implementation" | "testing";
  status: "idle" | "busy" | "offline";
  capabilities: string[];
  lastHeartbeat: string;
  currentTask?: string;
}

// GET /api/agents/:id
// エージェント詳細取得
interface GetAgentResponse {
  agent: Agent;
  recentTasks: Task[];
  stats: AgentStats;
}
```

#### タスク API

```typescript
// GET /api/tasks
// タスク一覧取得
interface GetTasksQuery {
  status?: "pending" | "in_progress" | "completed" | "failed";
  agentType?: string;
  limit?: number;
  offset?: number;
}

interface GetTasksResponse {
  tasks: Task[];
  total: number;
}

interface Task {
  id: string;
  traceId: string;
  agentType: string;
  status: string;
  description: string;
  createdAt: string;
  startedAt?: string;
  completedAt?: string;
  errorMessage?: string;
  retryCount: number;
}

// POST /api/tasks
// タスク作成
interface CreateTaskRequest {
  agentType: string;
  description: string;
  priority?: number;
  metadata?: Record<string, unknown>;
}

interface CreateTaskResponse {
  task: Task;
}

// DELETE /api/tasks/:id
// タスクキャンセル
interface CancelTaskResponse {
  success: boolean;
  message: string;
}
```

#### イベント API

```typescript
// POST /api/events
// イベント受信（Hooks用）
interface CreateEventRequest {
  source_app: string;
  session_id: string;
  hook_event_type: string;
  payload: Record<string, unknown>;
  timestamp?: string;
}

interface CreateEventResponse {
  id: number;
  received: boolean;
}

// GET /api/events
// イベント一覧取得
interface GetEventsQuery {
  sessionId?: string;
  eventType?: string;
  since?: string;
  limit?: number;
}

interface GetEventsResponse {
  events: Event[];
  total: number;
}

interface Event {
  id: number;
  sourceApp: string;
  sessionId: string;
  hookEventType: string;
  payload: Record<string, unknown>;
  timestamp: string;
  createdAt: string;
}
```

#### メトリクス API

```typescript
// GET /api/metrics
// メトリクス取得
interface GetMetricsQuery {
  period?: "1h" | "24h" | "7d" | "30d";
}

interface GetMetricsResponse {
  taskStats: {
    total: number;
    completed: number;
    failed: number;
    pending: number;
    inProgress: number;
  };
  agentStats: {
    total: number;
    active: number;
    idle: number;
    offline: number;
  };
  performance: {
    avgTaskDuration: number;
    successRate: number;
  };
  activity: {
    timestamp: string;
    eventCount: number;
    taskCount: number;
  }[];
}
```

### 4.2 WebSocket プロトコル

```typescript
// クライアント → サーバー
interface ClientMessage {
  type: "subscribe" | "unsubscribe" | "ping";
  channel?: string;
}

// サーバー → クライアント
interface ServerMessage {
  type: "event" | "agent_update" | "task_update" | "pong" | "error";
  data: unknown;
  timestamp: string;
}

// イベント通知
interface EventNotification {
  type: "event";
  data: Event;
}

// エージェント更新通知
interface AgentUpdateNotification {
  type: "agent_update";
  data: {
    agentId: string;
    status: string;
    previousStatus?: string;
  };
}

// タスク更新通知
interface TaskUpdateNotification {
  type: "task_update";
  data: {
    taskId: string;
    status: string;
    previousStatus?: string;
  };
}
```

---

## 5. Hooks統合設計

### 5.1 Hooks設定ファイル

```json
// .claude/settings.json
{
  "hooks": {
    "PostToolUse": [
      {
        "matcher": { "tool_name": "*" },
        "commands": [
          "python ${CLAUDE_PROJECT_DIR}/.claude/hooks/send_event.py PostToolUse"
        ]
      }
    ],
    "PreToolUse": [
      {
        "matcher": { "tool_name": "*" },
        "commands": [
          "python ${CLAUDE_PROJECT_DIR}/.claude/hooks/send_event.py PreToolUse"
        ]
      }
    ],
    "SessionStart": [
      {
        "commands": [
          "python ${CLAUDE_PROJECT_DIR}/.claude/hooks/send_event.py SessionStart"
        ]
      }
    ],
    "SessionEnd": [
      {
        "commands": [
          "python ${CLAUDE_PROJECT_DIR}/.claude/hooks/send_event.py SessionEnd"
        ]
      }
    ],
    "Notification": [
      {
        "commands": [
          "python ${CLAUDE_PROJECT_DIR}/.claude/hooks/send_event.py Notification"
        ]
      }
    ]
  }
}
```

### 5.2 Hooks送信スクリプト

```python
#!/usr/bin/env python3
# .claude/hooks/send_event.py

import sys
import json
import os
import httpx
from datetime import datetime

DASHBOARD_URL = os.environ.get("AOD_URL", "http://localhost:4000")
SOURCE_APP = os.environ.get("AOD_PROJECT", "default")

def main():
    if len(sys.argv) < 2:
        sys.exit(1)

    event_type = sys.argv[1]

    # 標準入力からペイロード読み取り
    try:
        payload = json.load(sys.stdin)
    except:
        payload = {}

    event = {
        "source_app": SOURCE_APP,
        "session_id": payload.get("session_id", "unknown"),
        "hook_event_type": event_type,
        "payload": payload,
        "timestamp": datetime.utcnow().isoformat() + "Z"
    }

    try:
        response = httpx.post(
            f"{DASHBOARD_URL}/api/events",
            json=event,
            timeout=5.0
        )
        response.raise_for_status()
    except Exception as e:
        # エラーは無視（Hooks失敗でエージェントを止めない）
        pass

if __name__ == "__main__":
    main()
```

---

## 6. シーケンス図

### 6.1 イベント受信フロー

```
┌─────────┐     ┌─────────┐     ┌─────────┐     ┌─────────┐     ┌─────────┐
│  Agent  │     │  Hooks  │     │API Gate │     │ SQLite  │     │Dashboard│
│(Claude) │     │ Script  │     │  way    │     │         │     │   UI    │
└────┬────┘     └────┬────┘     └────┬────┘     └────┬────┘     └────┬────┘
     │               │               │               │               │
     │ Tool Execute  │               │               │               │
     │──────────────>│               │               │               │
     │               │               │               │               │
     │               │ POST /events  │               │               │
     │               │──────────────>│               │               │
     │               │               │               │               │
     │               │               │ INSERT event  │               │
     │               │               │──────────────>│               │
     │               │               │               │               │
     │               │               │ WebSocket broadcast           │
     │               │               │──────────────────────────────>│
     │               │               │               │               │
     │               │  200 OK       │               │               │
     │               │<──────────────│               │               │
     │               │               │               │               │
```

### 6.2 タスク状態同期フロー

```
┌─────────┐     ┌─────────┐     ┌─────────┐     ┌─────────┐
│Dashboard│     │API Gate │     │  Redis  │     │MCP Orch │
│   UI    │     │  way    │     │         │     │ Server  │
└────┬────┘     └────┬────┘     └────┬────┘     └────┬────┘
     │               │               │               │
     │ GET /tasks    │               │               │
     │──────────────>│               │               │
     │               │               │               │
     │               │ SCAN task:*   │               │
     │               │──────────────>│               │
     │               │               │               │
     │               │ task data     │               │
     │               │<──────────────│               │
     │               │               │               │
     │ tasks[]       │               │               │
     │<──────────────│               │               │
     │               │               │               │
     │               │     (Agent polls and updates) │
     │               │               │<─────────────>│
     │               │               │               │
     │               │ SUBSCRIBE     │               │
     │               │──────────────>│               │
     │               │               │               │
     │               │ task update   │               │
     │               │<──────────────│               │
     │               │               │               │
     │ WebSocket     │               │               │
     │ task_update   │               │               │
     │<──────────────│               │               │
     │               │               │               │
```

---

## 7. デプロイメント設計

### 7.1 Docker Compose構成

```yaml
# docker-compose.yml
version: '3.8'

services:
  # ダッシュボードフロントエンド
  dashboard:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    ports:
      - "3000:3000"
    environment:
      - NEXT_PUBLIC_API_URL=http://localhost:4000
      - NEXT_PUBLIC_WS_URL=ws://localhost:4000
    depends_on:
      - api

  # API Gateway
  api:
    build:
      context: ./server
      dockerfile: Dockerfile
    ports:
      - "4000:4000"
    environment:
      - REDIS_URL=redis://redis:6379
      - DATABASE_PATH=/data/aod.db
    volumes:
      - ./data:/data
    depends_on:
      - redis

  # Redis（既存MCP Server用）
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes

  # MCP Orchestration Server（既存）
  mcp-server:
    build:
      context: ../mcp-orchestration-server/mcp-server
      dockerfile: Dockerfile
    ports:
      - "3001:3001"
    environment:
      - REDIS_URL=redis://redis:6379
    depends_on:
      - redis

volumes:
  redis_data:
```

### 7.2 ディレクトリ構成

```
ai-orchestration-dashboard/
├── docker-compose.yml
├── .env.example
├── README.md
├── docs/
│   ├── PRJ-2026-002_企画書.md
│   ├── REQ-2026-002_要件定義書.md
│   └── DES-2026-002_設計書.md
├── frontend/
│   ├── Dockerfile
│   ├── package.json
│   ├── next.config.js
│   ├── tailwind.config.js
│   ├── tsconfig.json
│   └── src/
├── server/
│   ├── Dockerfile
│   ├── package.json
│   ├── tsconfig.json
│   └── src/
├── hooks/
│   ├── send_event.py
│   └── settings.json.example
├── scripts/
│   ├── setup.sh
│   ├── start.sh
│   └── stop.sh
└── .claude/
    └── CLAUDE.md
```

---

## 8. セキュリティ設計

### 8.1 入力バリデーション

```typescript
// Zodスキーマでバリデーション
import { z } from "zod";

const EventSchema = z.object({
  source_app: z.string().min(1).max(100),
  session_id: z.string().uuid(),
  hook_event_type: z.enum([
    "PreToolUse",
    "PostToolUse",
    "SessionStart",
    "SessionEnd",
    "Notification",
    "Stop",
    "SubagentStop",
  ]),
  payload: z.record(z.unknown()),
  timestamp: z.string().datetime().optional(),
});

const TaskCreateSchema = z.object({
  agentType: z.enum(["planning", "implementation", "testing"]),
  description: z.string().min(1).max(1000),
  priority: z.number().int().min(0).max(10).optional(),
  metadata: z.record(z.unknown()).optional(),
});
```

### 8.2 レート制限

```typescript
// Hooks受信のレート制限
const rateLimiter = {
  windowMs: 1000, // 1秒
  max: 100, // 100リクエスト/秒
};
```

---

## 9. 監視・ログ設計

### 9.1 ログフォーマット

```typescript
// 構造化ログ
interface LogEntry {
  timestamp: string;
  level: "debug" | "info" | "warn" | "error";
  message: string;
  context?: {
    requestId?: string;
    sessionId?: string;
    agentId?: string;
    taskId?: string;
  };
  error?: {
    name: string;
    message: string;
    stack?: string;
  };
}
```

### 9.2 ヘルスチェック

```typescript
// GET /health
interface HealthResponse {
  status: "healthy" | "degraded" | "unhealthy";
  version: string;
  uptime: number;
  checks: {
    redis: "up" | "down";
    sqlite: "up" | "down";
    websocket: "up" | "down";
  };
}
```

---

## 10. テスト戦略

### 10.1 テスト種別

| 種別 | 対象 | ツール |
|------|------|--------|
| Unit Test | Services, Utilities | Vitest |
| Integration Test | API Endpoints | Vitest + Supertest |
| E2E Test | Full Flow | Playwright |
| Load Test | WebSocket, API | k6 |

### 10.2 テストカバレッジ目標

| コンポーネント | カバレッジ目標 |
|----------------|----------------|
| Services | 80%+ |
| API Routes | 70%+ |
| UI Components | 60%+ |

---

## 変更履歴

| バージョン | 日付 | 変更者 | 変更内容 |
|-----------|------|--------|----------|
| 1.0 | 2026/01/18 | Cosara + Claude | 初版作成 |
