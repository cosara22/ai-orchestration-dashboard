# 設計書：AI Orchestration Dashboard

**文書番号**: DES-2026-002
**作成日**: 2026年1月18日
**更新日**: 2026年1月18日
**作成者**: Cosara + Claude Code
**ステータス**: Draft
**関連文書**: PRJ-2026-002, REQ-2026-002

---

## 0. 開発環境

### 0.1 実行環境

| 項目 | 値 |
|------|-----|
| OS | Ubuntu 24.04 LTS (WSL2) |
| プロジェクトパス | `~/dev/projects/ai-orchestration-dashboard/` |
| Node.js | v24.x (fnm管理) |
| Python | 3.12.x (system) |
| パッケージマネージャ | pnpm (Node.js), uv (Python) |
| コンテナ | Docker Desktop (WSL2統合) |
| IDE | Cursor / VS Code (Remote WSL) |

### 0.2 関連リポジトリ

| リポジトリ | パス | 用途 |
|------------|------|------|
| ai-orchestration-dashboard | `~/dev/projects/ai-orchestration-dashboard/` | 本プロジェクト |
| mcp-orchestration-server | `~/dev/projects/mcp-orchestration-server/` | 既存MCPサーバー (クローン予定) |

### 0.3 起動コマンド

```bash
# プロジェクトディレクトリへ移動
cd ~/dev/projects/ai-orchestration-dashboard

# 全サービス起動
docker compose up -d

# 開発モード（フロントエンド）
cd frontend && pnpm dev

# 開発モード（バックエンド）
cd server && bun run dev
```

---

## 1. システムアーキテクチャ

### 1.1 全体構成図

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              Client Layer                                    │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │                    Dashboard Frontend (Next.js)                        │  │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐     │  │
│  │  │ AgentPanel  │ │ TaskPanel   │ │ EventPanel  │ │ MetricsPanel│     │  │
│  │  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘     │  │
│  │                              ↓                                         │  │
│  │  ┌─────────────────────────────────────────────────────────────────┐  │  │
│  │  │              State Management (Zustand / React Query)            │  │  │
│  │  └─────────────────────────────────────────────────────────────────┘  │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────────┘
                    ↓ REST API                    ↓ WebSocket
┌─────────────────────────────────────────────────────────────────────────────┐
│                              API Layer                                       │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │                 Unified API Gateway (Bun + Hono)                       │  │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐     │  │
│  │  │ /api/agents │ │ /api/tasks  │ │ /api/events │ │ /ws         │     │  │
│  │  └──────┬──────┘ └──────┬──────┘ └──────┬──────┘ └──────┬──────┘     │  │
│  │         │               │               │               │             │  │
│  │  ┌──────┴───────────────┴───────────────┴───────────────┴──────┐     │  │
│  │  │                    Service Layer                             │     │  │
│  │  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐       │     │  │
│  │  │  │ AgentService │  │ TaskService  │  │ EventService │       │     │  │
│  │  │  └──────────────┘  └──────────────┘  └──────────────┘       │     │  │
│  │  └─────────────────────────────────────────────────────────────┘     │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────────┘
                    ↓                                     ↓
┌───────────────────────────────┐     ┌───────────────────────────────────────┐
│        Data Layer             │     │           Integration Layer            │
│  ┌─────────────────────────┐  │     │  ┌─────────────────────────────────┐  │
│  │   SQLite (WAL mode)     │  │     │  │         Redis Adapter           │  │
│  │  ┌─────────┐            │  │     │  │  ┌─────────────────────────┐    │  │
│  │  │ events  │            │  │     │  │  │ MCP Orchestration Server│    │  │
│  │  │ metrics │            │  │     │  │  │ (既存: Redis Backend)   │    │  │
│  │  └─────────┘            │  │     │  │  └─────────────────────────┘    │  │
│  └─────────────────────────┘  │     │  └─────────────────────────────────┘  │
└───────────────────────────────┘     └───────────────────────────────────────┘
                                                          ↓ MCP Protocol
┌─────────────────────────────────────────────────────────────────────────────┐
│                           Agent Layer                                        │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐           │
│  │ Orchestrator│ │  Planning   │ │Implementation│ │  Testing   │           │
│  │   (紫)      │ │   (青)      │ │    (緑)      │ │   (橙)     │           │
│  │   Cursor    │ │   Cursor    │ │   Cursor     │ │   Cursor   │           │
│  └──────┬──────┘ └──────┬──────┘ └──────┬───────┘ └──────┬─────┘           │
│         └────────────────┴───────────────┴───────────────┘                  │
│                                  ↓ Hooks (HTTP POST)                         │
│                          API Gateway /api/events                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 1.2 技術スタック

| レイヤー | 技術 | 選定理由 |
|----------|------|----------|
| Frontend | Next.js 14 (App Router) | 既存テンプレート活用、RSC対応 |
| State Management | Zustand + React Query | 軽量、WebSocket統合が容易 |
| Styling | Tailwind CSS + shadcn/ui | 高速開発、一貫性 |
| Charts | Chart.js / Recharts | 軽量、カスタマイズ性 |
| API Gateway | Bun + Hono | 高速、TypeScript native |
| Database | SQLite (better-sqlite3) | WALモード、ゼロ設定 |
| Redis Client | ioredis | 高機能、TypeScript対応 |
| WebSocket | Bun WebSocket | 組み込み、高性能 |

---

## 2. コンポーネント設計

### 2.1 Frontend コンポーネント構成

```
frontend/
├── src/
│   ├── app/
│   │   ├── layout.tsx              # ルートレイアウト
│   │   ├── page.tsx                # ダッシュボードメイン
│   │   ├── agents/page.tsx         # エージェント詳細
│   │   ├── tasks/page.tsx          # タスク管理
│   │   ├── events/page.tsx         # イベントログ
│   │   └── metrics/page.tsx        # メトリクス
│   ├── components/
│   │   ├── layout/                 # Header, Sidebar, ProjectSelector
│   │   ├── agents/                 # AgentCard, AgentList, AgentStatus
│   │   ├── tasks/                  # TaskCard, TaskList, TaskFilter
│   │   ├── events/                 # EventItem, EventTimeline
│   │   └── metrics/                # MetricCard, ActivityChart
│   ├── hooks/                      # useWebSocket, useAgents, useTasks
│   ├── stores/                     # Zustand stores
│   ├── lib/                        # api, websocket, utils
│   └── types/                      # 型定義
├── package.json
├── next.config.js
├── tailwind.config.js
└── Dockerfile
```

### 2.2 Backend コンポーネント構成

```
server/
├── src/
│   ├── index.ts                # エントリーポイント
│   ├── routes/                 # agents, tasks, events, metrics, health
│   ├── services/               # agentService, taskService, eventService
│   ├── adapters/               # redis, sqlite
│   ├── websocket/              # handler, broadcaster
│   ├── middleware/             # cors, logger, validation
│   └── types/                  # 型定義
├── db/
│   ├── schema.sql
│   └── migrations/
├── package.json
└── Dockerfile
```

---

## 3. データベース設計

### 3.1 SQLite スキーマ

```sql
-- イベントテーブル
CREATE TABLE events (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    source_app TEXT NOT NULL,
    session_id TEXT NOT NULL,
    hook_event_type TEXT NOT NULL,
    payload JSON NOT NULL,
    timestamp DATETIME NOT NULL,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_events_session ON events(session_id);
CREATE INDEX idx_events_type ON events(hook_event_type);
CREATE INDEX idx_events_timestamp ON events(timestamp);

-- メトリクステーブル
CREATE TABLE metrics (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    metric_name TEXT NOT NULL,
    metric_value REAL NOT NULL,
    dimensions JSON,
    timestamp DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- プロジェクトテーブル
CREATE TABLE projects (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name TEXT UNIQUE NOT NULL,
    description TEXT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

### 3.2 Redis キー設計（既存MCPサーバー）

```
agent:{agent_id}       # HASH: id, type, status, capabilities, last_heartbeat
task:{task_id}         # HASH: id, trace_id, agent_type, status, description, timestamps
queue:{agent_type}     # LIST: タスクキュー
dead_letter_queue      # LIST: 失敗タスク
shared_state:{key}     # STRING: 共有データ
```

---

## 4. API設計

### 4.1 REST API

| メソッド | パス | 説明 |
|----------|------|------|
| GET | /api/agents | エージェント一覧 |
| GET | /api/agents/:id | エージェント詳細 |
| GET | /api/tasks | タスク一覧 |
| POST | /api/tasks | タスク作成 |
| DELETE | /api/tasks/:id | タスクキャンセル |
| POST | /api/events | イベント受信（Hooks用） |
| GET | /api/events | イベント一覧 |
| GET | /api/metrics | メトリクス取得 |
| GET | /health | ヘルスチェック |

### 4.2 WebSocket

```typescript
// サーバー → クライアント
type ServerMessage =
  | { type: "event"; data: Event }
  | { type: "agent_update"; data: AgentUpdate }
  | { type: "task_update"; data: TaskUpdate }
  | { type: "pong" }
```

---

## 5. Hooks統合設計

### 5.1 設定ファイル

```json
// ~/dev/projects/[project-name]/.claude/settings.json
{
  "hooks": {
    "PostToolUse": [{
      "matcher": { "tool_name": "*" },
      "commands": ["python ${CLAUDE_PROJECT_DIR}/.claude/hooks/send_event.py PostToolUse"]
    }],
    "SessionStart": [{
      "commands": ["python ${CLAUDE_PROJECT_DIR}/.claude/hooks/send_event.py SessionStart"]
    }],
    "SessionEnd": [{
      "commands": ["python ${CLAUDE_PROJECT_DIR}/.claude/hooks/send_event.py SessionEnd"]
    }]
  }
}
```

### 5.2 送信スクリプト

```python
#!/usr/bin/env python3
# .claude/hooks/send_event.py
import sys, json, os, httpx
from datetime import datetime

DASHBOARD_URL = os.environ.get("AOD_URL", "http://localhost:4000")
SOURCE_APP = os.environ.get("AOD_PROJECT", os.path.basename(os.getcwd()))

def main():
    if len(sys.argv) < 2: sys.exit(1)
    event_type = sys.argv[1]
    try: payload = json.load(sys.stdin)
    except: payload = {}

    event = {
        "source_app": SOURCE_APP,
        "session_id": payload.get("session_id", "unknown"),
        "hook_event_type": event_type,
        "payload": payload,
        "timestamp": datetime.utcnow().isoformat() + "Z"
    }
    try: httpx.post(f"{DASHBOARD_URL}/api/events", json=event, timeout=5.0)
    except: pass

if __name__ == "__main__": main()
```

---

## 6. デプロイメント設計

### 6.1 Docker Compose

```yaml
# ~/dev/projects/ai-orchestration-dashboard/docker-compose.yml
version: "3.8"
services:
  dashboard:
    build: ./frontend
    ports: ["3000:3000"]
    environment:
      - NEXT_PUBLIC_API_URL=http://localhost:4000
    depends_on: [api]

  api:
    build: ./server
    ports: ["4000:4000"]
    environment:
      - REDIS_URL=redis://redis:6379
      - DATABASE_PATH=/data/aod.db
    volumes: ["./data:/data"]
    depends_on: [redis]

  redis:
    image: redis:7-alpine
    ports: ["6379:6379"]
    volumes: ["redis_data:/data"]

volumes:
  redis_data:
```

### 6.2 ディレクトリ構成

```
~/dev/projects/ai-orchestration-dashboard/
├── docker-compose.yml
├── .env.example
├── .gitignore
├── README.md
├── docs/
│   ├── PRJ-2026-002_企画書.md
│   ├── REQ-2026-002_要件定義書.md
│   └── DES-2026-002_設計書.md
├── frontend/
│   ├── Dockerfile
│   ├── package.json
│   └── src/
├── server/
│   ├── Dockerfile
│   ├── package.json
│   └── src/
├── hooks/
│   ├── send_event.py
│   └── settings.json.example
├── scripts/
│   ├── setup.sh
│   ├── start.sh
│   └── stop.sh
├── data/
└── .claude/
    └── CLAUDE.md
```

---

## 7. セキュリティ・テスト

### 7.1 入力バリデーション

Zodスキーマで全API入力を検証

### 7.2 レート制限

100リクエスト/秒

### 7.3 テスト戦略

| 種別 | ツール |
|------|--------|
| Unit Test | Vitest |
| Integration Test | Vitest + Supertest |
| E2E Test | Playwright |

---

## 変更履歴

| バージョン | 日付 | 変更者 | 変更内容 |
|-----------|------|--------|----------|
| 1.0 | 2026/01/18 | Cosara + Claude | 初版作成 |
| 1.1 | 2026/01/18 | Cosara + Claude | Ubuntu環境対応、開発環境セクション追加 |
