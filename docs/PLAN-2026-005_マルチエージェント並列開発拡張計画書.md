# マルチエージェント並列開発拡張 実装計画書

**文書番号**: PLAN-2026-005
**作成日**: 2026年1月19日
**作成者**: Cosara + Claude Code
**ステータス**: Draft
**関連文書**: PRJ-2026-002, DES-2026-002, PLAN-2026-004

---

## 1. 概要

### 1.1 目的

AODをマルチエージェントによる組織的な並列開発プラットフォームとして拡張し、以下の主要機能を実装する：

1. **タスクキュー & 自動割り当て** - 優先度付きキューとエージェントへの自動ディスパッチ
2. **エージェント能力管理** - スキルタグによるタスク-エージェントマッチング
3. **ファイルロック & 競合管理** - 並列作業時のリソース排他制御
4. **コンダクターエージェント** - 全体統括・オーケストレーション機能
5. **共有コンテキスト** - エージェント間の情報共有基盤

### 1.2 想定される効果

| 効果 | 説明 |
|------|------|
| 開発効率の向上 | 複数エージェントによる並列作業で開発速度向上 |
| 競合の防止 | ファイルロックにより同一ファイルの編集衝突を回避 |
| 適材適所の配置 | 能力マッチングで最適なエージェントにタスクを割り当て |
| 全体最適化 | コンダクターによる俯瞰的な進捗管理とリソース調整 |
| 知識の共有 | 共有コンテキストでエージェント間の学習を促進 |

### 1.3 ユースケース

```
┌─────────────────────────────────────────────────────────────────────┐
│                    マルチエージェント並列開発                        │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ┌──────────────┐                                                  │
│  │ Conductor    │ ← 全体統括・タスク分解・進捗監視                 │
│  │ Agent        │                                                  │
│  └──────┬───────┘                                                  │
│         │ タスク割り当て                                            │
│         ▼                                                          │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │                    Task Queue                                 │  │
│  │  [P0: 認証API] [P1: 検索UI] [P1: テスト] [P2: ドキュメント]   │  │
│  └──────────────────────────────────────────────────────────────┘  │
│         │                                                          │
│         ▼ 能力マッチング＆自動割り当て                             │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐         │
│  │ Backend  │  │ Frontend │  │ Test     │  │ Docs     │         │
│  │ Agent    │  │ Agent    │  │ Agent    │  │ Agent    │         │
│  │ [backend]│  │ [react]  │  │ [test]   │  │ [docs]   │         │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘         │
│       │              │            │              │                 │
│       ▼              ▼            ▼              ▼                 │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │              Shared Context / Blackboard                      │  │
│  │  - 作業状況    - 学習内容    - ブロッカー    - 決定事項       │  │
│  └──────────────────────────────────────────────────────────────┘  │
│       │                                                            │
│       ▼                                                            │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │              File Lock Manager                                │  │
│  │  src/auth/jwt.ts → locked by Backend Agent                    │  │
│  │  src/components/Search.tsx → locked by Frontend Agent         │  │
│  └──────────────────────────────────────────────────────────────┘  │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 2. アーキテクチャ

### 2.1 全体構成

```
┌─────────────────────────────────────────────────────────────────────┐
│                         Dashboard Frontend                           │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐              │
│  │ Orchestration│  │ Task Queue   │  │ Agent        │              │
│  │ Dashboard    │  │ Panel        │  │ Monitor      │              │
│  └──────────────┘  └──────────────┘  └──────────────┘              │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐              │
│  │ Lock         │  │ Context      │  │ Conflict     │              │
│  │ Visualizer   │  │ Viewer       │  │ Resolver     │              │
│  └──────────────┘  └──────────────┘  └──────────────┘              │
└─────────────────────────────────────────────────────────────────────┘
                              ↓ REST API / WebSocket
┌─────────────────────────────────────────────────────────────────────┐
│                         API Gateway                                  │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐              │
│  │ /api/queue/  │  │ /api/locks/  │  │ /api/        │              │
│  │ tasks        │  │ files        │  │ context      │              │
│  └──────────────┘  └──────────────┘  └──────────────┘              │
│                              ↓                                       │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │                  Orchestration Engine                        │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │   │
│  │  │ Task        │  │ Capability  │  │ Lock        │         │   │
│  │  │ Dispatcher  │  │ Matcher     │  │ Manager     │         │   │
│  │  └─────────────┘  └─────────────┘  └─────────────┘         │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │   │
│  │  │ Conductor   │  │ Conflict    │  │ Context     │         │   │
│  │  │ Controller  │  │ Detector    │  │ Manager     │         │   │
│  │  └─────────────┘  └─────────────┘  └─────────────┘         │   │
│  └─────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────────┐
│                         Data Layer                                   │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐              │
│  │ task_queue   │  │ file_locks   │  │ shared_      │              │
│  │ (新規)       │  │ (新規)       │  │ context(新規)│              │
│  └──────────────┘  └──────────────┘  └──────────────┘              │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐              │
│  │ agent_       │  │ conductor_   │  │ conflict_    │              │
│  │ capabilities │  │ decisions    │  │ history      │              │
│  │ (新規)       │  │ (新規)       │  │ (新規)       │              │
│  └──────────────┘  └──────────────┘  └──────────────┘              │
└─────────────────────────────────────────────────────────────────────┘
```

### 2.2 データモデル拡張

```sql
-- タスクキューテーブル（新規）
CREATE TABLE IF NOT EXISTS task_queue (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    queue_id TEXT UNIQUE NOT NULL,
    project_id TEXT NOT NULL,
    task_id TEXT NOT NULL,                    -- 既存tasksテーブルへの参照
    priority INTEGER DEFAULT 1,               -- 0=P0(最高), 1=P1, 2=P2
    required_capabilities TEXT,               -- 必要スキル（JSON配列）
    assigned_agent_id TEXT,                   -- 割り当て済みエージェント
    status TEXT DEFAULT 'pending',            -- pending, assigned, in_progress, completed, failed, blocked
    enqueued_at TEXT DEFAULT CURRENT_TIMESTAMP,
    assigned_at TEXT,
    started_at TEXT,
    completed_at TEXT,
    timeout_minutes INTEGER DEFAULT 60,       -- タイムアウト設定
    retry_count INTEGER DEFAULT 0,
    max_retries INTEGER DEFAULT 3,
    metadata TEXT,                            -- 追加情報（JSON）
    FOREIGN KEY (project_id) REFERENCES projects(project_id),
    FOREIGN KEY (task_id) REFERENCES tasks(task_id),
    FOREIGN KEY (assigned_agent_id) REFERENCES agents(agent_id)
);

-- エージェント能力テーブル（新規）
CREATE TABLE IF NOT EXISTS agent_capabilities (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    capability_id TEXT UNIQUE NOT NULL,
    agent_id TEXT NOT NULL,
    capability TEXT NOT NULL,                 -- backend, frontend, test, docs, devops, etc.
    proficiency INTEGER DEFAULT 3,            -- 1-5 (5=expert)
    verified BOOLEAN DEFAULT 0,               -- 実績で検証済みか
    last_used TEXT,
    success_rate REAL DEFAULT 0.0,            -- この能力でのタスク成功率
    created_at TEXT DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (agent_id) REFERENCES agents(agent_id)
);

-- 能力タグマスター（新規）
CREATE TABLE IF NOT EXISTS capability_tags (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    tag TEXT UNIQUE NOT NULL,
    category TEXT NOT NULL,                   -- language, framework, domain, tool
    description TEXT,
    parent_tag TEXT,                          -- 階層構造（例: react → frontend）
    created_at TEXT DEFAULT CURRENT_TIMESTAMP
);

-- ファイルロックテーブル（新規）
CREATE TABLE IF NOT EXISTS file_locks (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    lock_id TEXT UNIQUE NOT NULL,
    project_id TEXT NOT NULL,
    file_path TEXT NOT NULL,                  -- ロック対象ファイルパス
    agent_id TEXT NOT NULL,                   -- ロック保持エージェント
    lock_type TEXT DEFAULT 'exclusive',       -- exclusive, shared
    reason TEXT,                              -- ロック理由
    acquired_at TEXT DEFAULT CURRENT_TIMESTAMP,
    expires_at TEXT,                          -- 有効期限
    released_at TEXT,
    status TEXT DEFAULT 'active',             -- active, released, expired
    FOREIGN KEY (project_id) REFERENCES projects(project_id),
    FOREIGN KEY (agent_id) REFERENCES agents(agent_id)
);

-- 共有コンテキストテーブル（新規）
CREATE TABLE IF NOT EXISTS shared_context (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    context_id TEXT UNIQUE NOT NULL,
    project_id TEXT NOT NULL,
    context_type TEXT NOT NULL,               -- decision, blocker, learning, status, artifact
    title TEXT NOT NULL,
    content TEXT NOT NULL,                    -- マークダウンまたはJSON
    author_agent_id TEXT,                     -- 作成したエージェント
    visibility TEXT DEFAULT 'all',            -- all, team, private
    priority INTEGER DEFAULT 0,               -- 重要度
    tags TEXT,                                -- JSON配列
    related_task_id TEXT,                     -- 関連タスク
    related_file_paths TEXT,                  -- 関連ファイル（JSON配列）
    expires_at TEXT,                          -- 有効期限（状態情報など）
    created_at TEXT DEFAULT CURRENT_TIMESTAMP,
    updated_at TEXT DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (project_id) REFERENCES projects(project_id),
    FOREIGN KEY (author_agent_id) REFERENCES agents(agent_id)
);

-- コンダクター意思決定ログ（新規）
CREATE TABLE IF NOT EXISTS conductor_decisions (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    decision_id TEXT UNIQUE NOT NULL,
    project_id TEXT NOT NULL,
    decision_type TEXT NOT NULL,              -- assignment, priority_change, escalation, reallocation, intervention
    description TEXT NOT NULL,
    affected_agents TEXT,                     -- 影響を受けたエージェント（JSON配列）
    affected_tasks TEXT,                      -- 影響を受けたタスク（JSON配列）
    rationale TEXT,                           -- 意思決定の根拠
    outcome TEXT,                             -- success, partial, failed, pending
    decided_at TEXT DEFAULT CURRENT_TIMESTAMP,
    executed_at TEXT,
    metadata TEXT,                            -- 追加情報（JSON）
    FOREIGN KEY (project_id) REFERENCES projects(project_id)
);

-- 競合履歴テーブル（新規）
CREATE TABLE IF NOT EXISTS conflict_history (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    conflict_id TEXT UNIQUE NOT NULL,
    project_id TEXT NOT NULL,
    conflict_type TEXT NOT NULL,              -- file_edit, schedule, resource, dependency
    involved_agents TEXT NOT NULL,            -- 関係エージェント（JSON配列）
    involved_resources TEXT NOT NULL,         -- 競合リソース（JSON）
    description TEXT,
    resolution_strategy TEXT,                 -- wait, merge, escalate, rollback
    resolution_result TEXT,                   -- 解決結果
    detected_at TEXT DEFAULT CURRENT_TIMESTAMP,
    resolved_at TEXT,
    status TEXT DEFAULT 'detected',           -- detected, resolving, resolved, escalated
    FOREIGN KEY (project_id) REFERENCES projects(project_id)
);

-- インデックス
CREATE INDEX IF NOT EXISTS idx_task_queue_status ON task_queue(status);
CREATE INDEX IF NOT EXISTS idx_task_queue_priority ON task_queue(priority, enqueued_at);
CREATE INDEX IF NOT EXISTS idx_task_queue_agent ON task_queue(assigned_agent_id);
CREATE INDEX IF NOT EXISTS idx_agent_capabilities_agent ON agent_capabilities(agent_id);
CREATE INDEX IF NOT EXISTS idx_agent_capabilities_capability ON agent_capabilities(capability);
CREATE INDEX IF NOT EXISTS idx_file_locks_file ON file_locks(project_id, file_path);
CREATE INDEX IF NOT EXISTS idx_file_locks_agent ON file_locks(agent_id);
CREATE INDEX IF NOT EXISTS idx_shared_context_project ON shared_context(project_id);
CREATE INDEX IF NOT EXISTS idx_shared_context_type ON shared_context(context_type);
```

---

## 3. 実装フェーズ

### Phase 15-A: タスクキュー & 自動割り当て（優先度: 最高）

**目標**: 優先度付きタスクキューと空きエージェントへの自動ディスパッチ

#### タスク一覧

| ID | タスク | 見積もり | 依存 |
|----|--------|----------|------|
| 15A-1 | DBスキーマ追加（task_queue） | 0.5h | - |
| 15A-2 | タスクキューCRUD API実装 | 2h | 15A-1 |
| 15A-3 | 優先度ソートロジック実装 | 1h | 15A-2 |
| 15A-4 | エージェント空き状況チェック機能 | 1h | 15A-2 |
| 15A-5 | 自動割り当てディスパッチャー実装 | 3h | 15A-3, 15A-4 |
| 15A-6 | タイムアウト・リトライ機構 | 2h | 15A-5 |
| 15A-7 | タスクキューUIパネル実装 | 3h | 15A-2 |
| 15A-8 | WebSocket通知連携 | 1h | 15A-5 |
| 15A-9 | エージェントへのタスク通知API | 1h | 15A-8 |

**自動割り当てアルゴリズム**:

```typescript
interface TaskDispatcher {
  // 次に割り当てるタスクを選択
  selectNextTask(): QueuedTask | null;

  // 適切なエージェントを選択
  selectAgent(task: QueuedTask, availableAgents: Agent[]): Agent | null;

  // 割り当て実行
  assignTask(task: QueuedTask, agent: Agent): AssignmentResult;
}

// 優先度計算
function calculatePriority(task: QueuedTask): number {
  return task.priority * 1000
    + (Date.now() - task.enqueued_at.getTime()) / 60000  // 待機時間ボーナス
    + (task.dependencies_completed ? 100 : 0);           // 依存完了ボーナス
}
```

**成果物**:
- `server/src/routes/queue.ts`
- `server/src/lib/taskDispatcher.ts`
- `frontend/src/components/TaskQueuePanel.tsx`

---

### Phase 15-B: エージェント能力管理（優先度: 高）

**目標**: スキルタグによるエージェント-タスクマッチング

#### タスク一覧

| ID | タスク | 見積もり | 依存 |
|----|--------|----------|------|
| 15B-1 | DBスキーマ追加（agent_capabilities, capability_tags） | 0.5h | - |
| 15B-2 | 能力タグマスターデータ投入 | 1h | 15B-1 |
| 15B-3 | エージェント能力CRUD API | 2h | 15B-1 |
| 15B-4 | 能力マッチングエンジン実装 | 3h | 15B-3 |
| 15B-5 | タスク要件と能力のスコアリング | 2h | 15B-4 |
| 15B-6 | 能力の自動学習（成功率更新） | 2h | 15B-5 |
| 15B-7 | エージェント能力UIパネル | 2h | 15B-3 |
| 15B-8 | タスク作成時の能力要件設定UI | 1h | 15B-7 |

**能力マッチングスコアリング**:

```typescript
interface CapabilityMatcher {
  // タスク要件とエージェント能力のマッチングスコア計算
  calculateMatchScore(
    requiredCapabilities: string[],
    agentCapabilities: AgentCapability[]
  ): number;

  // 最適なエージェントを推薦
  recommendAgents(
    task: QueuedTask,
    availableAgents: Agent[]
  ): AgentRecommendation[];
}

interface AgentRecommendation {
  agent: Agent;
  matchScore: number;        // 0-100
  matchedCapabilities: string[];
  missingCapabilities: string[];
  estimatedSuccessRate: number;
}
```

**能力タグ階層**:

```
capabilities/
├── language/
│   ├── typescript
│   ├── python
│   ├── go
│   └── rust
├── framework/
│   ├── frontend/
│   │   ├── react
│   │   ├── nextjs
│   │   └── vue
│   └── backend/
│       ├── hono
│       ├── express
│       └── fastapi
├── domain/
│   ├── api
│   ├── database
│   ├── authentication
│   └── testing
└── tool/
    ├── git
    ├── docker
    └── ci-cd
```

**成果物**:
- `server/src/routes/capabilities.ts`
- `server/src/lib/capabilityMatcher.ts`
- `frontend/src/components/AgentCapabilityPanel.tsx`

---

### Phase 15-C: ファイルロック & 競合管理（優先度: 高）

**目標**: 並列作業時のファイル編集競合を防止

#### タスク一覧

| ID | タスク | 見積もり | 依存 |
|----|--------|----------|------|
| 15C-1 | DBスキーマ追加（file_locks, conflict_history） | 0.5h | - |
| 15C-2 | ファイルロックCRUD API | 2h | 15C-1 |
| 15C-3 | ロック取得/解放ロジック | 2h | 15C-2 |
| 15C-4 | ロック有効期限・自動解放機構 | 1h | 15C-3 |
| 15C-5 | 競合検出ロジック | 2h | 15C-3 |
| 15C-6 | 競合履歴記録 | 1h | 15C-5 |
| 15C-7 | ロック可視化UIパネル | 2h | 15C-2 |
| 15C-8 | 競合アラート通知 | 1h | 15C-5 |
| 15C-9 | Claude Code Hooks連携（ファイル編集前ロック確認） | 2h | 15C-3 |

**ファイルロックAPI**:

```typescript
// ロック取得
POST /api/locks/acquire
{
  project_id: string;
  file_path: string;
  agent_id: string;
  lock_type: "exclusive" | "shared";
  reason?: string;
  timeout_minutes?: number;
}

// Response
{
  success: boolean;
  lock_id?: string;
  conflict?: {
    locked_by: string;
    agent_name: string;
    acquired_at: string;
    reason: string;
  };
}

// ロック解放
POST /api/locks/release
{
  lock_id: string;
  agent_id: string;
}

// 一括ロック状態確認
GET /api/locks/status?project_id=xxx&paths[]=path1&paths[]=path2
```

**Hooks連携**:

```python
# .claude/hooks/check_file_lock.py
# PreToolUse: Write, Edit の前に呼び出し

import requests
import json
import sys

def check_lock(file_path, agent_id):
    response = requests.get(
        f"{AOD_URL}/api/locks/check",
        params={"file_path": file_path, "agent_id": agent_id}
    )
    result = response.json()

    if result.get("locked") and result.get("locked_by") != agent_id:
        print(json.dumps({
            "decision": "block",
            "reason": f"File locked by {result['locked_by_name']}"
        }))
        sys.exit(1)

    # ロック取得
    requests.post(f"{AOD_URL}/api/locks/acquire", json={
        "file_path": file_path,
        "agent_id": agent_id,
        "lock_type": "exclusive"
    })
```

**成果物**:
- `server/src/routes/locks.ts`
- `server/src/lib/lockManager.ts`
- `frontend/src/components/FileLockPanel.tsx`
- `.claude/hooks/check_file_lock.py`

---

### Phase 15-D: コンダクターエージェント（優先度: 中）

**目標**: 全体統括・オーケストレーション機能

#### タスク一覧

| ID | タスク | 見積もり | 依存 |
|----|--------|----------|------|
| 15D-1 | DBスキーマ追加（conductor_decisions） | 0.5h | - |
| 15D-2 | コンダクターAPI設計・実装 | 3h | 15D-1 |
| 15D-3 | タスク分解ロジック | 3h | 15D-2 |
| 15D-4 | 進捗監視・ボトルネック検出 | 2h | 15D-2 |
| 15D-5 | 動的リソース再配置ロジック | 3h | 15D-4 |
| 15D-6 | エスカレーション機構 | 2h | 15D-4 |
| 15D-7 | 意思決定ログ記録 | 1h | 15D-2 |
| 15D-8 | コンダクターダッシュボードUI | 3h | 15D-2 |
| 15D-9 | 人間介入インターフェース | 2h | 15D-8 |

**コンダクターAPI**:

```typescript
// プロジェクト状況取得
GET /api/conductor/status/:project_id
{
  overall_progress: number;
  active_agents: AgentStatus[];
  queued_tasks: number;
  blocked_tasks: BlockedTask[];
  bottlenecks: Bottleneck[];
  estimated_completion: string;
}

// タスク分解リクエスト
POST /api/conductor/decompose
{
  project_id: string;
  high_level_task: string;
  context?: string;
}
// Response: { subtasks: Task[] }

// リソース再配置
POST /api/conductor/reallocate
{
  project_id: string;
  from_agent_id: string;
  to_agent_id: string;
  task_ids: string[];
  reason: string;
}

// エスカレーション
POST /api/conductor/escalate
{
  project_id: string;
  issue_type: "blocker" | "conflict" | "delay" | "quality";
  description: string;
  affected_tasks: string[];
  suggested_actions?: string[];
}

// 人間介入リクエスト
POST /api/conductor/request-intervention
{
  project_id: string;
  urgency: "low" | "medium" | "high" | "critical";
  description: string;
  options?: InterventionOption[];
}
```

**コンダクター意思決定フロー**:

```
┌─────────────────────────────────────────────────────────────────────┐
│                    Conductor Decision Flow                          │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ┌──────────────┐                                                  │
│  │ Monitor Loop │ (定期実行: 30秒間隔)                             │
│  └──────┬───────┘                                                  │
│         │                                                          │
│         ▼                                                          │
│  ┌──────────────┐     ┌──────────────┐     ┌──────────────┐       │
│  │ 進捗チェック │ ──▶ │ 遅延検出     │ ──▶ │ 原因分析     │       │
│  └──────────────┘     └──────────────┘     └──────────────┘       │
│                                                   │                 │
│                       ┌───────────────────────────┼─────────────┐  │
│                       ▼                           ▼             ▼  │
│               ┌──────────────┐           ┌──────────────┐          │
│               │ 自動対応     │           │ エスカレート │          │
│               │ - 優先度変更 │           │ - 人間に通知 │          │
│               │ - 再割り当て │           │ - 判断を仰ぐ │          │
│               └──────────────┘           └──────────────┘          │
│                       │                           │                 │
│                       ▼                           ▼                 │
│               ┌──────────────────────────────────────────────┐     │
│               │              Decision Log                     │     │
│               │  - 何を決定したか                             │     │
│               │  - なぜその決定をしたか                       │     │
│               │  - 結果はどうだったか                         │     │
│               └──────────────────────────────────────────────┘     │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

**成果物**:
- `server/src/routes/conductor.ts`
- `server/src/lib/conductorEngine.ts`
- `frontend/src/components/ConductorDashboard.tsx`

---

### Phase 15-E: 共有コンテキスト（優先度: 中）

**目標**: エージェント間の情報共有基盤

#### タスク一覧

| ID | タスク | 見積もり | 依存 |
|----|--------|----------|------|
| 15E-1 | DBスキーマ追加（shared_context） | 0.5h | - |
| 15E-2 | コンテキストCRUD API | 2h | 15E-1 |
| 15E-3 | コンテキストタイプ別フィルタリング | 1h | 15E-2 |
| 15E-4 | 有効期限・自動アーカイブ機構 | 1h | 15E-2 |
| 15E-5 | コンテキスト検索機能 | 2h | 15E-2 |
| 15E-6 | エージェントへのコンテキスト注入API | 2h | 15E-2 |
| 15E-7 | コンテキストビューワーUI | 2h | 15E-2 |
| 15E-8 | コンテキスト投稿UI | 1h | 15E-7 |
| 15E-9 | Claude Code起動時コンテキスト取得Hooks | 2h | 15E-6 |

**コンテキストタイプ**:

| タイプ | 説明 | 例 |
|--------|------|-----|
| `decision` | 意思決定 | 「認証方式はJWTを採用」 |
| `blocker` | ブロッカー | 「APIレート制限に到達」 |
| `learning` | 学習内容 | 「このライブラリはReact 19で動かない」 |
| `status` | 状態報告 | 「認証API実装70%完了」 |
| `artifact` | 成果物 | 「設計ドキュメントへのリンク」 |
| `warning` | 警告 | 「本番環境への変更は要承認」 |

**コンテキスト注入API**:

```typescript
// エージェント起動時にコンテキスト取得
GET /api/context/for-agent/:agent_id?project_id=xxx
{
  relevant_contexts: SharedContext[];
  active_blockers: SharedContext[];
  recent_decisions: SharedContext[];
  team_status: SharedContext[];
}

// 新規コンテキスト投稿
POST /api/context
{
  project_id: string;
  context_type: string;
  title: string;
  content: string;
  author_agent_id: string;
  tags?: string[];
  related_task_id?: string;
  expires_in_hours?: number;
}
```

**Hooks連携（起動時コンテキスト注入）**:

```python
# .claude/hooks/inject_context.py
# SessionStart時に呼び出し

import requests
import json

def get_context_for_agent(agent_id, project_id):
    response = requests.get(
        f"{AOD_URL}/api/context/for-agent/{agent_id}",
        params={"project_id": project_id}
    )
    contexts = response.json()

    # コンテキストをClaude Code起動時に注入
    inject_message = format_context_message(contexts)
    return inject_message

def format_context_message(contexts):
    msg = "## 📋 Current Project Context\n\n"

    if contexts.get("active_blockers"):
        msg += "### ⛔ Active Blockers\n"
        for b in contexts["active_blockers"]:
            msg += f"- **{b['title']}**: {b['content']}\n"

    if contexts.get("recent_decisions"):
        msg += "\n### 🎯 Recent Decisions\n"
        for d in contexts["recent_decisions"]:
            msg += f"- **{d['title']}**: {d['content']}\n"

    return msg
```

**成果物**:
- `server/src/routes/context.ts`
- `server/src/lib/contextManager.ts`
- `frontend/src/components/ContextViewer.tsx`
- `.claude/hooks/inject_context.py`

---

## 4. API設計サマリー

### 4.1 タスクキューAPI

```
POST /api/queue/enqueue            - タスクをキューに追加
GET  /api/queue/list               - キュー一覧取得
GET  /api/queue/next               - 次の割り当て候補取得
POST /api/queue/:id/assign         - タスク割り当て
POST /api/queue/:id/start          - タスク開始
POST /api/queue/:id/complete       - タスク完了
POST /api/queue/:id/fail           - タスク失敗
POST /api/queue/:id/retry          - リトライ
GET  /api/queue/stats              - キュー統計情報
```

### 4.2 能力管理API

```
GET  /api/capabilities/tags                    - タグ一覧
POST /api/capabilities/tags                    - タグ追加
GET  /api/capabilities/agent/:id               - エージェント能力取得
POST /api/capabilities/agent/:id               - 能力追加
PUT  /api/capabilities/agent/:id/:cap_id       - 能力更新
POST /api/capabilities/match                   - マッチングスコア計算
GET  /api/capabilities/recommend               - 推薦エージェント取得
```

### 4.3 ファイルロックAPI

```
POST /api/locks/acquire            - ロック取得
POST /api/locks/release            - ロック解放
GET  /api/locks/check              - ロック状態確認
GET  /api/locks/list               - ロック一覧
GET  /api/locks/agent/:id          - エージェント保持ロック
POST /api/locks/force-release      - 強制解放（管理者用）
GET  /api/conflicts/history        - 競合履歴
```

### 4.4 コンダクターAPI

```
GET  /api/conductor/status/:project_id         - 全体状況
POST /api/conductor/decompose                  - タスク分解
POST /api/conductor/reallocate                 - リソース再配置
POST /api/conductor/escalate                   - エスカレーション
POST /api/conductor/request-intervention       - 人間介入リクエスト
GET  /api/conductor/decisions                  - 意思決定ログ
POST /api/conductor/override                   - 手動オーバーライド
```

### 4.5 共有コンテキストAPI

```
GET  /api/context                              - コンテキスト一覧
POST /api/context                              - コンテキスト投稿
GET  /api/context/:id                          - コンテキスト詳細
PUT  /api/context/:id                          - コンテキスト更新
DELETE /api/context/:id                        - コンテキスト削除
GET  /api/context/for-agent/:agent_id          - エージェント向けコンテキスト
GET  /api/context/search                       - コンテキスト検索
```

---

## 5. 実装スケジュール

```
Phase 15-A: タスクキュー & 自動割り当て
├─ 15A-1 ~ 15A-4: 基盤実装 .................. Day 1
├─ 15A-5 ~ 15A-6: ディスパッチャー .......... Day 2
└─ 15A-7 ~ 15A-9: UI・通知 .................. Day 3

Phase 15-B: エージェント能力管理
├─ 15B-1 ~ 15B-3: DB・API ................... Day 4
├─ 15B-4 ~ 15B-6: マッチングエンジン ........ Day 5
└─ 15B-7 ~ 15B-8: UI ........................ Day 6

Phase 15-C: ファイルロック & 競合管理
├─ 15C-1 ~ 15C-4: ロック機構 ................ Day 7
├─ 15C-5 ~ 15C-6: 競合検出 .................. Day 8
└─ 15C-7 ~ 15C-9: UI・Hooks連携 ............. Day 9

Phase 15-D: コンダクターエージェント
├─ 15D-1 ~ 15D-3: 基盤・タスク分解 .......... Day 10
├─ 15D-4 ~ 15D-6: 監視・再配置 .............. Day 11-12
└─ 15D-7 ~ 15D-9: ログ・UI .................. Day 13

Phase 15-E: 共有コンテキスト
├─ 15E-1 ~ 15E-4: DB・API ................... Day 14
├─ 15E-5 ~ 15E-6: 検索・注入 ................ Day 15
└─ 15E-7 ~ 15E-9: UI・Hooks ................. Day 16

統合テスト & 調整 ............................ Day 17-20

総見積もり: 約20日（実装のみ、テスト込み）
```

---

## 6. テスト計画

### 6.1 Phase 15-A テスト

| テストID | テスト内容 | 期待結果 |
|----------|-----------|----------|
| T15A-1 | タスクがキューに追加される | DBに保存、優先度でソート |
| T15A-2 | 空きエージェントにタスクが割り当てられる | assigned_agent_idが設定 |
| T15A-3 | タイムアウト後にリトライされる | retry_countが増加、再キュー |
| T15A-4 | 優先度の高いタスクが先に処理される | P0 > P1 > P2の順序 |
| T15A-5 | WebSocketで割り当て通知が送信される | 対象エージェントに通知 |

### 6.2 Phase 15-B テスト

| テストID | テスト内容 | 期待結果 |
|----------|-----------|----------|
| T15B-1 | エージェントに能力が登録される | capabilitiesテーブルに保存 |
| T15B-2 | タスク要件とマッチングスコアが計算される | 0-100のスコア |
| T15B-3 | 最適なエージェントが推薦される | スコア順のリスト |
| T15B-4 | タスク完了時に成功率が更新される | success_rateが再計算 |

### 6.3 Phase 15-C テスト

| テストID | テスト内容 | 期待結果 |
|----------|-----------|----------|
| T15C-1 | ファイルロックが取得できる | lock_idが返される |
| T15C-2 | ロック済みファイルへの再ロックが拒否される | conflict情報が返される |
| T15C-3 | 有効期限切れロックが自動解放される | statusがexpiredに変更 |
| T15C-4 | 競合が検出・記録される | conflict_historyに保存 |
| T15C-5 | Hooksでロック確認が行われる | ロック未取得時にブロック |

### 6.4 Phase 15-D テスト

| テストID | テスト内容 | 期待結果 |
|----------|-----------|----------|
| T15D-1 | プロジェクト全体状況が取得できる | 進捗・ボトルネック情報 |
| T15D-2 | タスクが適切にサブタスクに分解される | 依存関係を持つタスクリスト |
| T15D-3 | 遅延が検出される | bottlenecksに含まれる |
| T15D-4 | リソース再配置が実行される | タスクが別エージェントに移動 |
| T15D-5 | 意思決定がログに記録される | conductor_decisionsに保存 |

### 6.5 Phase 15-E テスト

| テストID | テスト内容 | 期待結果 |
|----------|-----------|----------|
| T15E-1 | コンテキストが投稿できる | shared_contextに保存 |
| T15E-2 | エージェント向けコンテキストが取得できる | 関連コンテキストのリスト |
| T15E-3 | 有効期限切れコンテキストがアーカイブされる | アクティブから除外 |
| T15E-4 | 検索でコンテキストが見つかる | タイトル・内容でヒット |
| T15E-5 | Hooks起動時にコンテキストが注入される | Claude Codeに情報が渡る |

---

## 7. リスクと対策

| リスク | 影響度 | 対策 |
|--------|--------|------|
| タスク割り当ての競合 | 高 | 楽観的ロック + リトライ機構 |
| ファイルロックのデッドロック | 高 | タイムアウト + 強制解放機能 |
| コンダクターの過負荷 | 中 | バッチ処理 + 非同期実行 |
| コンテキスト肥大化 | 中 | 有効期限 + 自動アーカイブ |
| エージェント障害 | 高 | ハートビート監視 + 自動再割り当て |
| 能力マッチング精度 | 中 | 実績ベースの自動調整 |

---

## 8. 成功基準

### Phase 15-A
- [ ] 10個以上のタスクが同時にキューイングできる
- [ ] 5分以内に空きエージェントにタスクが割り当てられる
- [ ] タイムアウト後に自動リトライが行われる

### Phase 15-B
- [ ] 5種類以上の能力タグでマッチングができる
- [ ] マッチングスコアが80%以上のタスクが成功率70%以上

### Phase 15-C
- [ ] 同一ファイルへの同時編集が防止される
- [ ] ロック競合が100%検出される
- [ ] デッドロックなしで10時間連続運用できる

### Phase 15-D
- [ ] 全エージェントの状況が1画面で把握できる
- [ ] ボトルネックが5分以内に検出される
- [ ] 人間介入リクエストが即座に通知される

### Phase 15-E
- [ ] エージェント起動時に関連コンテキストが自動取得される
- [ ] 検索で目的のコンテキストが3秒以内に見つかる
- [ ] ブロッカーが全エージェントに共有される

---

## 9. 将来の拡張

### 9.1 Phase 16候補

1. **自動マージ・PR管理**
   - ブランチ戦略の自動化
   - 自動コードレビュー
   - マージ競合の自動解決

2. **予測・分析機能**
   - 完了時間予測
   - ボトルネック予測
   - リソース需要予測

3. **学習・最適化**
   - 割り当てアルゴリズムの自動最適化
   - エージェント能力の自動推定
   - ベストプラクティスの自動抽出

4. **外部連携**
   - GitHub/GitLab統合
   - Slack/Teams通知
   - CI/CDパイプライン連携

---

## 10. 次のステップ

1. **Phase 15-A開始**: タスクキューのDB・API設計レビュー
2. **並行準備**: 能力タグマスターデータの設計
3. **実装開始**: 計画承認後、Phase 15-Aから順次実装

---

**承認**: [ ] 計画承認待ち
**作成者**: Claude Code
**レビュー者**: Cosara
